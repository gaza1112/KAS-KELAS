<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buku Kas Kelas - X-L</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* slate-900 */
        }
        .btn-day.active {
            background-color: #2563eb; /* blue-600 */
            color: white;
            font-weight: 600;
            border-color: #2563eb;
        }
        .btn-day {
            transition: all 0.2s ease-in-out;
        }
        .student-entry {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .modal-backdrop {
            transition: opacity 0.3s ease;
        }
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
        /* Toggle Switch Style */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #3b82f6;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #3b82f6;
        }
        /* Toast Notification */
        #toast {
            transition: opacity 0.5s, transform 0.5s;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-200">

    <!-- Login View -->
    <div id="login-view" class="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-slate-900 to-slate-800">
        <div class="w-full max-w-sm bg-slate-800/50 backdrop-blur-sm p-8 rounded-2xl shadow-2xl border border-slate-700">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-blue-400">Kas Kelas X-L</h1>
                <p class="text-slate-400 mt-2">Masukkan PIN Admin untuk melanjutkan</p>
            </div>
            <form id="login-form">
                <div class="mb-6">
                    <input type="password" id="pin" inputmode="numeric" pattern="[0-9]*" maxlength="6" class="w-full text-center text-3xl sm:text-4xl tracking-[.5em] px-4 py-3 border bg-slate-900 border-slate-700 text-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" required>
                </div>
                <p id="login-error" class="text-red-400 text-sm text-center mb-4 h-5"></p>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition-transform transform hover:scale-105 shadow-lg">
                    Masuk
                </button>
            </form>
        </div>
    </div>

    <!-- App View -->
    <div id="app-view" class="hidden">
        <div class="container mx-auto max-w-lg p-4 min-h-screen bg-slate-900">
            <header class="text-center py-4">
                <h1 class="text-3xl sm:text-4xl font-bold text-blue-400">KAS KELAS X-L</h1>
                <p class="text-slate-400 mt-1">Pencatat Keuangan Kelas</p>
            </header>

            <div class="my-6 p-5 bg-slate-800 rounded-xl shadow-lg border border-slate-700">
                 <div class="grid grid-cols-2 gap-4 mb-5">
                    <div>
                        <label for="month-select" class="block text-sm font-medium text-slate-400 mb-1">Bulan</label>
                        <select id="month-select" class="w-full px-3 py-2 border bg-slate-700 border-slate-600 text-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500"></select>
                    </div>
                    <div>
                        <label for="week-select" class="block text-sm font-medium text-slate-400 mb-1">Minggu</label>
                        <select id="week-select" class="w-full px-3 py-2 border bg-slate-700 border-slate-600 text-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="1">Minggu 1</option>
                            <option value="2">Minggu 2</option>
                            <option value="3">Minggu 3</option>
                            <option value="4">Minggu 4</option>
                        </select>
                    </div>
                </div>
                <div id="summary" class="text-center border-t border-slate-700 pt-4">
                    <p class="text-lg text-slate-300">Kas Terkumpul (Minggu Ini):</p>
                    <p id="total-kas" class="text-4xl sm:text-5xl font-bold text-green-400">Rp 0</p>
                    <p id="paid-summary" class="text-slate-400 mt-1">0 dari 36 siswa telah membayar.</p>
                </div>
                <div class="mt-5 border-t border-slate-700 pt-4">
                    <div class="flex justify-between items-center">
                        <p class="font-semibold text-slate-300">Pilih Hari Pembayaran:</p>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm font-medium text-slate-400">Mode Penagihan</span>
                            <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="billing-toggle" id="billing-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                <label for="billing-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-600 cursor-pointer"></label>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mt-2">
                        <button id="btn-selasa" class="btn-day w-full py-2 px-4 rounded-lg border border-slate-600 bg-slate-700 hover:bg-slate-600">Selasa</button>
                        <button id="btn-jumat" class="btn-day w-full py-2 px-4 rounded-lg border border-slate-600 bg-slate-700 hover:bg-slate-600">Jumat</button>
                    </div>
                </div>
            </div>

            <main>
                <div id="student-list" class="space-y-2"></div>
            </main>

            <footer class="mt-8 text-center space-y-4">
                 <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <button id="tambah-donasi-button" class="flex items-center justify-center gap-2 bg-teal-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-teal-700 transition-all transform hover:scale-105 shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 3.5a1.5 1.5 0 013 0V4a1 1 0 001 1h3a1 1 0 011 1v2.5a1.5 1.5 0 01-3 0V8a1 1 0 00-1-1H9.5a1.5 1.5 0 01-3 0V7a1 1 0 00-1-1H2a1 1 0 01-1-1V3.5a1.5 1.5 0 013 0V4a1 1 0 001 1h3a1 1 0 011-1V3.5zM3 11.5a1.5 1.5 0 013 0V12a1 1 0 001 1h6a1 1 0 001-1v-.5a1.5 1.5 0 013 0v.5a3 3 0 01-3 3H7a3 3 0 01-3-3v-.5z" /></svg>
                        Donasi
                    </button>
                    <button id="tambah-pengeluaran-button" class="flex items-center justify-center gap-2 bg-yellow-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-yellow-700 transition-all transform hover:scale-105 shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" /></svg>
                        Pengeluaran
                    </button>
                    <button id="total-kas-button" class="flex items-center justify-center gap-2 bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-all transform hover:scale-105 shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M2 10a8 8 0 018-8v8h8a8 8 0 11-16 0z" /><path d="M12 2.252A8.014 8.014 0 0117.748 8H12V2.252z" /></svg>
                        Total
                    </button>
                    <button id="download-button" class="flex items-center justify-center gap-2 bg-green-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-green-700 transition-all transform hover:scale-105 shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                        Laporan
                    </button>
                 </div>
                 <div class="flex justify-center gap-4 flex-wrap pt-2">
                    <button id="backup-button" class="bg-slate-500 text-white font-semibold py-2 px-6 rounded-lg hover:bg-slate-600 transition-colors">Backup Data</button>
                    <label for="restore-input" class="cursor-pointer bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors">Upload Backup</label>
                    <input type="file" id="restore-input" class="hidden" accept=".json">
                 </div>
                 <p class="text-xs text-slate-600 pt-4">sing gae gaza cok.</p>
            </footer>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="pengeluaran-modal" class="fixed inset-0 bg-black bg-opacity-70 modal-backdrop flex items-center justify-center p-4 hidden">
        <div class="bg-slate-800 border border-slate-700 rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-bold text-center">Catat Pengeluaran Baru</h3>
            <form id="pengeluaran-form">
                <div class="mt-4">
                    <label for="pengeluaran-keterangan" class="block text-sm font-medium text-slate-300 mb-1">Keterangan</label>
                    <input type="text" id="pengeluaran-keterangan" placeholder="Contoh: Beli spidol papan tulis" class="w-full px-4 py-2 border bg-slate-700 border-slate-600 text-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="mt-4">
                    <label for="pengeluaran-jumlah" class="block text-sm font-medium text-slate-300 mb-1">Jumlah (Rp)</label>
                    <input type="number" id="pengeluaran-jumlah" placeholder="Contoh: 15000" class="w-full px-4 py-2 border bg-slate-700 border-slate-600 text-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="batal-pengeluaran" class="px-4 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-500">Batal</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <div id="donasi-modal" class="fixed inset-0 bg-black bg-opacity-70 modal-backdrop flex items-center justify-center p-4 hidden">
        <div class="bg-slate-800 border border-slate-700 rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-bold text-center">Catat Donasi Baru</h3>
            <form id="donasi-form">
                <div class="mt-4">
                    <label for="donasi-jumlah" class="block text-sm font-medium text-slate-300 mb-1">Jumlah (Rp)</label>
                    <input type="number" id="donasi-jumlah" placeholder="Contoh: 50000" class="w-full px-4 py-2 border bg-slate-700 border-slate-600 text-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="batal-donasi" class="px-4 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-500">Batal</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <div id="total-kas-modal" class="fixed inset-0 bg-black bg-opacity-70 modal-backdrop flex items-center justify-center p-4 hidden">
        <div class="bg-slate-800 border border-slate-700 rounded-lg shadow-xl p-6 w-full max-w-md text-center">
            <h3 class="text-xl font-bold text-blue-400">Rangkuman Kas Keseluruhan</h3>
            <div class="text-left mt-6 space-y-2">
                <div class="flex justify-between items-center">
                    <span class="text-slate-400">Total Pemasukan Kas:</span>
                    <span id="display-pemasukan" class="font-semibold text-green-400 text-lg">Rp 0</span>
                </div>
                 <div class="flex justify-between items-center">
                    <span class="text-slate-400">Total Pemasukan Donasi:</span>
                    <span id="display-donasi" class="font-semibold text-teal-400 text-lg">Rp 0</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-slate-400">Total Pengeluaran:</span>
                    <span id="display-pengeluaran" class="font-semibold text-red-400 text-lg">Rp 0</span>
                </div>
            </div>
            <hr class="border-slate-600 my-4">
            <p class="text-slate-300 text-xl">Saldo Akhir:</p>
            <p class="text-4xl sm:text-5xl font-bold text-blue-400 my-2" id="display-saldo-akhir">Rp 0</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6 text-left">
                <div>
                    <h4 class="font-semibold mb-2">Rincian Donasi:</h4>
                    <div id="rincian-donasi-list" class="max-h-32 overflow-y-auto space-y-2 pr-2"></div>
                </div>
                <div>
                    <h4 class="font-semibold mb-2">Rincian Pengeluaran:</h4>
                    <div id="rincian-pengeluaran-list" class="max-h-32 overflow-y-auto space-y-2 pr-2"></div>
                </div>
            </div>

            <div class="flex justify-center mt-6">
                <button id="close-total-kas-modal" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg transform translate-y-20 opacity-0">
        Data berhasil dipulihkan!
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const loginView = document.getElementById('login-view');
            const appView = document.getElementById('app-view');
            const loginForm = document.getElementById('login-form');
            const loginError = document.getElementById('login-error');

            const STUDENT_LIST = [
                "Achmad Ilham", "Alvia Eren Istiqomah", "Ananda Ridho Aditama", "Amelia Dewi Maharani", "Angelita Aura Aprilia", "Anisa Nurul Aini", "Arifa Intan Nurlatif", "Aurellia Tungga Dewi", "Azzahra Putri Amira", "Cindy Intan Hadi Saputri", "Dhea Agusfina Al Warois", "Dhimas Satrio Kurniawan", "Farih Naura Asfiya", "Gaza Tanziilal Furqon", "Gista Nazuilla Armeli", "Intan Putri Agustina", "Irsya Nur Nazha", "Janice Vania", "Kanaya Anyhania Ramadhani", "Keyza Putri Ramadhani", "Laura Imalia Putri", "Lucky Leyva Lee Young Chu Jun", "Mochamad Akbar Saifudin Zuhri", "Muhamad Farhan Al Kafi", "Muhammad Nikko Setya Pratama", "Mutiara Nur Laili", "Nabilla Nois Raya Putri Setiawan", "Nandita Aulia", "Natasya Dewi", "Nia Avrillia", "Nicky Leyva Lee Young Chu Jun", "Nur Amira Triana Ikhsanty", "Risza Aulia Ainul Fitri", "Robana Qusnul Joelia", "Saecar Labib Kanhaya Siswanto", "Syevi Citrahrotunisa"
            ];
            const KAS_AMOUNT = 2000;
            const STORAGE_KEY = 'kasKelasXLData';

            // DOM Elements
            const studentListContainer = document.getElementById('student-list');
            const totalKasEl = document.getElementById('total-kas');
            const paidSummaryEl = document.getElementById('paid-summary');
            const btnSelasa = document.getElementById('btn-selasa');
            const btnJumat = document.getElementById('btn-jumat');
            const monthSelect = document.getElementById('month-select');
            const weekSelect = document.getElementById('week-select');
            const billingToggle = document.getElementById('billing-toggle');
            const toast = document.getElementById('toast');

            // Buttons
            const downloadButton = document.getElementById('download-button');
            const totalKasButton = document.getElementById('total-kas-button');
            const tambahPengeluaranButton = document.getElementById('tambah-pengeluaran-button');
            const tambahDonasiButton = document.getElementById('tambah-donasi-button');
            const backupButton = document.getElementById('backup-button');
            const restoreInput = document.getElementById('restore-input');

            // Modals
            const pengeluaranModal = document.getElementById('pengeluaran-modal');
            const donasiModal = document.getElementById('donasi-modal');
            const totalKasModal = document.getElementById('total-kas-modal');

            // Forms & Modal Controls
            const pengeluaranForm = document.getElementById('pengeluaran-form');
            const donasiForm = document.getElementById('donasi-form');
            const batalPengeluaranButton = document.getElementById('batal-pengeluaran');
            const batalDonasiButton = document.getElementById('batal-donasi');
            const closeTotalKasModal = document.getElementById('close-total-kas-modal');

            // Display elements in Total Modal
            const displayPemasukan = document.getElementById('display-pemasukan');
            const displayDonasi = document.getElementById('display-donasi');
            const displayPengeluaran = document.getElementById('display-pengeluaran');
            const displaySaldoAkhir = document.getElementById('display-saldo-akhir');
            const rincianDonasiList = document.getElementById('rincian-donasi-list');
            const rincianPengeluaranList = document.getElementById('rincian-pengeluaran-list');
            
            let currentDay = 'selasa';
            let allData = { kasData: {}, expenses: [], donations: [] };
            let isBillingMode = false;

            // --- Login Logic ---
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (document.getElementById('pin').value === '190609') {
                    loginError.textContent = '';
                    loginView.classList.add('hidden');
                    appView.classList.remove('hidden');
                    startApp();
                } else {
                    loginError.textContent = 'PIN salah.';
                }
            });

            // --- Data Handling Functions ---
            function loadAllData() {
                const dataString = localStorage.getItem(STORAGE_KEY);
                const loadedData = dataString ? JSON.parse(dataString) : { kasData: {}, expenses: [], donations: [] };
                if (!loadedData.kasData) loadedData.kasData = {};
                if (!loadedData.expenses) loadedData.expenses = [];
                if (!loadedData.donations) loadedData.donations = [];
                return loadedData;
            }

            function saveData() {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(allData));
            }

            function getDataForCurrentPeriod() {
                const periodKey = `${monthSelect.value}-${weekSelect.value}`;
                if (!allData.kasData[periodKey]) {
                    const initialData = {};
                    STUDENT_LIST.forEach((name, index) => {
                        initialData[`student_${index}`] = { name, selasa: false, jumat: false };
                    });
                    allData.kasData[periodKey] = initialData;
                    saveData();
                }
                return allData.kasData[periodKey];
            }

            // --- UI Functions ---
            function showToast(message, isError = false) {
                toast.textContent = message;
                toast.classList.remove('bg-green-500', 'bg-red-500');
                toast.classList.add(isError ? 'bg-red-500' : 'bg-green-500');
                toast.classList.remove('translate-y-20', 'opacity-0');
                setTimeout(() => {
                    toast.classList.add('translate-y-20', 'opacity-0');
                }, 3000);
            }

            function populateMonthSelector() {
                const months = ["Jan", "Feb", "Mar", "Apr", "Mei", "Jun", "Jul", "Agu", "Sep", "Okt", "Nov", "Des"];
                const startYear = 2025, endYear = 2026;
                monthSelect.innerHTML = '';
                for (let i = 6; i < 12; i++) {
                    const option = document.createElement('option');
                    option.value = `${startYear}-${i + 1}`;
                    option.textContent = `${months[i]} ${startYear}`;
                    monthSelect.appendChild(option);
                }
                for (let i = 0; i <= 6; i++) {
                    const option = document.createElement('option');
                    option.value = `${endYear}-${i + 1}`;
                    option.textContent = `${months[i]} ${endYear}`;
                    monthSelect.appendChild(option);
                }
            }

            function getTunggakan(studentId) {
                const tunggakan = [];
                const currentPeriodKey = `${monthSelect.value}-${weekSelect.value}`;
                const startPeriodKey = "2025-7-3"; 

                const allPossiblePeriods = [];
                const monthOptions = Array.from(monthSelect.options);
                
                for (const option of monthOptions) {
                    const monthPeriod = option.value;
                    for (let week = 1; week <= 4; week++) {
                        const periodKey = `${monthPeriod}-${week}`;
                        if (periodKey >= startPeriodKey && periodKey < currentPeriodKey) {
                            allPossiblePeriods.push(periodKey);
                        }
                    }
                }

                for (const periodKey of allPossiblePeriods) {
                    const studentDataForPeriod = allData.kasData[periodKey] ? allData.kasData[periodKey][studentId] : null;

                    const [year, month, week] = periodKey.split('-');
                    const monthOption = monthSelect.querySelector(`option[value="${year}-${month}"]`);
                    const monthName = monthOption ? monthOption.textContent.split(' ')[0] : 'Bulan';

                    if (studentDataForPeriod) {
                        if (!studentDataForPeriod.selasa) tunggakan.push(`${monthName} M${week} (Sel)`);
                        if (!studentDataForPeriod.jumat) tunggakan.push(`${monthName} M${week} (Jum)`);
                    } else {
                        tunggakan.push(`${monthName} M${week} (Sel)`);
                        tunggakan.push(`${monthName} M${week} (Jum)`);
                    }
                }
                return tunggakan;
            }

            function render() {
                const studentData = getDataForCurrentPeriod();
                studentListContainer.innerHTML = '';
                Object.keys(studentData).forEach((studentId, index) => {
                    const data = studentData[studentId];
                    const hasPaid = data[currentDay];
                    const entry = document.createElement('div');
                    let tunggakan = [];
                    if (isBillingMode) tunggakan = getTunggakan(studentId);
                    let highlightClass = '';
                    if (isBillingMode && tunggakan.length > 0) {
                        highlightClass = 'border-2 border-yellow-400';
                        entry.title = `Tunggakan:\n${tunggakan.join('\n')}`;
                    }
                    entry.className = `student-entry flex items-center justify-between p-3 rounded-lg shadow-sm ${hasPaid ? 'bg-green-500/10 text-green-300' : 'bg-red-500/10 text-red-300'} ${highlightClass}`;
                    entry.dataset.id = studentId;
                    const studentNameContainer = document.createElement('div');
                    studentNameContainer.className = 'flex items-center';
                    if (isBillingMode && tunggakan.length > 0) {
                        const warningIcon = document.createElement('span');
                        warningIcon.className = 'mr-2 text-yellow-400';
                        warningIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>`;
                        studentNameContainer.appendChild(warningIcon);
                    }
                    const studentName = document.createElement('span');
                    studentName.className = 'font-medium';
                    studentName.textContent = `${index + 1}. ${data.name}`;
                    studentNameContainer.appendChild(studentName);
                    const status = document.createElement('span');
                    status.className = `font-bold text-sm px-2 py-1 rounded-full ${hasPaid ? 'bg-green-500/20' : 'bg-red-500/20'}`;
                    status.textContent = hasPaid ? 'LUNAS' : 'BELUM';
                    entry.appendChild(studentNameContainer);
                    entry.appendChild(status);
                    entry.addEventListener('click', () => togglePayment(studentId));
                    studentListContainer.appendChild(entry);
                });
                updateSummary();
                updateActiveDayButton();
            }

            function updateSummary() {
                const studentData = getDataForCurrentPeriod();
                const paidCount = Object.values(studentData).filter(s => s[currentDay]).length;
                const total = paidCount * KAS_AMOUNT;
                totalKasEl.textContent = `Rp ${total.toLocaleString('id-ID')}`;
                paidSummaryEl.textContent = `${paidCount} dari ${STUDENT_LIST.length} siswa telah membayar.`;
            }

            function updateActiveDayButton() {
                btnSelasa.classList.toggle('active', currentDay === 'selasa');
                btnJumat.classList.toggle('active', currentDay === 'jumat');
            }
            
            // --- Event Handlers & Actions ---
            function togglePayment(studentId) {
                const studentData = getDataForCurrentPeriod();
                studentData[studentId][currentDay] = !studentData[studentId][currentDay];
                saveData();
                render();
            }

            function handleExpenseSubmit(e) {
                e.preventDefault();
                const keterangan = document.getElementById('pengeluaran-keterangan').value;
                const jumlah = parseInt(document.getElementById('pengeluaran-jumlah').value);
                if (keterangan && jumlah > 0) {
                    allData.expenses.push({ keterangan, jumlah, tanggal: new Date().toISOString() });
                    saveData();
                    pengeluaranForm.reset();
                    pengeluaranModal.classList.add('hidden');
                }
            }
            
            function handleDonationSubmit(e) {
                e.preventDefault();
                const jumlah = parseInt(document.getElementById('donasi-jumlah').value);
                if (jumlah > 0) {
                    allData.donations.push({ keterangan: "Donasi", jumlah, tanggal: new Date().toISOString() });
                    saveData();
                    donasiForm.reset();
                    donasiModal.classList.add('hidden');
                }
            }
            
            function deleteTransaction(type, tanggal) {
                allData[type] = allData[type].filter(item => item.tanggal !== tanggal);
                saveData();
                calculateAndShowTotalKas();
            }

            function calculateAndShowTotalKas() {
                let totalPemasukan = 0;
                Object.values(allData.kasData).forEach(period => Object.values(period).forEach(student => {
                    if (student.selasa) totalPemasukan += KAS_AMOUNT;
                    if (student.jumat) totalPemasukan += KAS_AMOUNT;
                }));
                let totalDonasi = allData.donations.reduce((sum, d) => sum + d.jumlah, 0);
                let totalPengeluaran = allData.expenses.reduce((sum, e) => sum + e.jumlah, 0);
                const saldoAkhir = (totalPemasukan + totalDonasi) - totalPengeluaran;

                rincianDonasiList.innerHTML = allData.donations.length === 0 ? '<p class="text-gray-500">Belum ada donasi.</p>' : '';
                allData.donations.forEach(donasi => createTransactionItem(rincianDonasiList, donasi, 'donations'));
                rincianPengeluaranList.innerHTML = allData.expenses.length === 0 ? '<p class="text-gray-500">Belum ada pengeluaran.</p>' : '';
                allData.expenses.forEach(expense => createTransactionItem(rincianPengeluaranList, expense, 'expenses'));

                displayPemasukan.textContent = `Rp ${totalPemasukan.toLocaleString('id-ID')}`;
                displayDonasi.textContent = `Rp ${totalDonasi.toLocaleString('id-ID')}`;
                displayPengeluaran.textContent = `Rp ${totalPengeluaran.toLocaleString('id-ID')}`;
                displaySaldoAkhir.textContent = `Rp ${saldoAkhir.toLocaleString('id-ID')}`;
                totalKasModal.classList.remove('hidden');
            }

            function createTransactionItem(listElement, itemData, type) {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center bg-slate-700 p-2 rounded';
                const details = document.createElement('div');
                details.className = 'text-left';
                details.innerHTML = `<span class="font-medium">${itemData.keterangan}</span><br><span class="text-xs text-slate-400">Rp ${itemData.jumlah.toLocaleString('id-ID')}</span>`;
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'text-red-400 hover:text-red-300 p-1';
                deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>`;
                deleteBtn.onclick = () => deleteTransaction(type, itemData.tanggal);
                item.appendChild(details);
                item.appendChild(deleteBtn);
                listElement.appendChild(item);
            }

            function downloadReport() {
                const selectedMonthText = monthSelect.options[monthSelect.selectedIndex].text;
                const selectedWeekText = weekSelect.options[weekSelect.selectedIndex].text;
                const currentPeriodData = allData.kasData[`${monthSelect.value}-${weekSelect.value}`] || {};
                
                let reportContent = `Laporan Kas Kelas X-L\n========================================\nLaporan dibuat pada: ${new Date().toLocaleString('id-ID')}\n\n`;

                let totalPemasukan = 0;
                Object.values(allData.kasData).forEach(p => Object.values(p).forEach(s => {
                    if(s.selasa) totalPemasukan += KAS_AMOUNT; if(s.jumat) totalPemasukan += KAS_AMOUNT;
                }));
                let totalDonasi = allData.donations.reduce((sum, d) => sum + d.jumlah, 0);
                let totalPengeluaran = allData.expenses.reduce((sum, e) => sum + e.jumlah, 0);
                const saldoAkhir = (totalPemasukan + totalDonasi) - totalPengeluaran;

                reportContent += `--- RANGKUMAN KEUANGAN KESELURUHAN ---\n`;
                reportContent += `Total Pemasukan Kas  : Rp ${totalPemasukan.toLocaleString('id-ID')}\n`;
                reportContent += `Total Pemasukan Donasi: Rp ${totalDonasi.toLocaleString('id-ID')}\n`;
                reportContent += `Total Pengeluaran    : Rp ${totalPengeluaran.toLocaleString('id-ID')}\n`;
                reportContent += `Saldo Akhir          : Rp ${saldoAkhir.toLocaleString('id-ID')}\n\n`;

                reportContent += `--- RINCIAN PEMBAYARAN UNTUK ${selectedMonthText.toUpperCase()} - ${selectedWeekText.toUpperCase()} ---\n`;
                const sudahBayar = [];
                const belumBayar = [];
                Object.values(currentPeriodData).forEach(student => {
                    if (student.selasa && student.jumat) {
                        sudahBayar.push(student.name);
                    } else {
                        let tunggakan = [];
                        if (!student.selasa) tunggakan.push("Selasa");
                        if (!student.jumat) tunggakan.push("Jumat");
                        belumBayar.push(`${student.name} (Belum: ${tunggakan.join(', ')})`);
                    }
                });

                reportContent += `Sudah Membayar (Lunas Minggu Ini):\n`;
                reportContent += sudahBayar.length > 0 ? sudahBayar.map((nama, i) => `${i + 1}. ${nama}`).join('\n') : 'Tidak ada.\n';
                reportContent += `\nBelum Membayar (Tunggakan Minggu Ini):\n`;
                reportContent += belumBayar.length > 0 ? belumBayar.map((nama, i) => `${i + 1}. ${nama}`).join('\n') : 'Tidak ada.\n';
                reportContent += `\n`;

                reportContent += `--- RINCIAN DONASI ---\n`;
                reportContent += allData.donations.length > 0 ? allData.donations.map(d => `- ${new Date(d.tanggal).toLocaleDateString('id-ID')}: ${d.keterangan.padEnd(30, ' ')} (Rp ${d.jumlah.toLocaleString('id-ID')})`).join('\n') : 'Tidak ada donasi.\n';
                reportContent += `\n`;

                reportContent += `--- RINCIAN PENGELUARAN ---\n`;
                reportContent += allData.expenses.length > 0 ? allData.expenses.map(e => `- ${new Date(e.tanggal).toLocaleDateString('id-ID')}: ${e.keterangan.padEnd(30, ' ')} (Rp ${e.jumlah.toLocaleString('id-ID')})`).join('\n') : 'Tidak ada pengeluaran.\n';
                
                const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `laporan-kas-keseluruhan-X-L.txt`;
                a.click();
                URL.revokeObjectURL(url);
            }
            
            function handleBackup() {
                const dataString = localStorage.getItem(STORAGE_KEY);
                if (!dataString || dataString === '{}') {
                    showToast("Tidak ada data untuk di-backup.", true);
                    return;
                }
                const blob = new Blob([dataString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const date = new Date().toISOString().slice(0, 10);
                a.href = url;
                a.download = `backup-kas-kelas-xl-${date}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }

            function handleRestore(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const restoredData = JSON.parse(e.target.result);
                        if (restoredData.kasData && restoredData.expenses && restoredData.donations) {
                            if (confirm("Anda yakin ingin menimpa semua data saat ini dengan data dari file backup? Tindakan ini tidak dapat dibatalkan.")) {
                                allData = restoredData;
                                saveData();
                                
                                const periodKeys = Object.keys(allData.kasData);
                                if (periodKeys.length > 0) {
                                    periodKeys.sort().reverse();
                                    const latestPeriod = periodKeys[0];
                                    const [year, month, week] = latestPeriod.split('-');
                                    monthSelect.value = `${year}-${month}`;
                                    weekSelect.value = week;
                                }
                                
                                render();
                                showToast("Data berhasil dipulihkan!");
                            }
                        } else {
                            showToast("File backup tidak valid.", true);
                        }
                    } catch (err) {
                        showToast("Gagal membaca file backup.", true);
                    } finally {
                        restoreInput.value = '';
                    }
                };
                reader.readAsText(file);
            }

            // --- Initialization ---
            function startApp() {
                allData = loadAllData();
                populateMonthSelector();
                monthSelect.value = '2025-7';
                weekSelect.value = '3';

                // Event Listeners
                monthSelect.addEventListener('change', render);
                weekSelect.addEventListener('change', render);
                btnSelasa.addEventListener('click', () => { currentDay = 'selasa'; render(); });
                btnJumat.addEventListener('click', () => { currentDay = 'jumat'; render(); });
                billingToggle.addEventListener('change', (e) => { isBillingMode = e.target.checked; render(); });
                
                downloadButton.addEventListener('click', downloadReport);
                totalKasButton.addEventListener('click', calculateAndShowTotalKas);
                tambahPengeluaranButton.addEventListener('click', () => pengeluaranModal.classList.remove('hidden'));
                tambahDonasiButton.addEventListener('click', () => donasiModal.classList.remove('hidden'));
                backupButton.addEventListener('click', handleBackup);
                restoreInput.addEventListener('change', handleRestore);
                
                pengeluaranForm.addEventListener('submit', handleExpenseSubmit);
                batalPengeluaranButton.addEventListener('click', () => pengeluaranModal.classList.add('hidden'));
                donasiForm.addEventListener('submit', handleDonationSubmit);
                batalDonasiButton.addEventListener('click', () => donasiModal.classList.add('hidden'));
                closeTotalKasModal.addEventListener('click', () => totalKasModal.classList.add('hidden'));

                render();
            }
        });
    </script>
</body>
</html>
