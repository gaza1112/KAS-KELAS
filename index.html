<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buku Kas Kelas - X-L</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .btn-day.active {
            background-color: #16A34A; /* green-600 */
            color: white;
            font-weight: 600;
            border-color: #16A34A;
        }
        .btn-day {
            transition: all 0.2s ease-in-out;
        }
        .student-entry {
            transition: background-color 0.3s ease;
            cursor: pointer;
        }
        .modal-backdrop {
            transition: opacity 0.3s ease;
        }
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <!-- App View -->
    <div id="app-view">
        <div class="container mx-auto max-w-lg p-4 min-h-screen bg-gray-800">
            <header class="text-center py-4 border-b-2 border-gray-700">
                <h1 class="text-3xl font-bold text-blue-400">KAS KELAS X-L</h1>
                <p class="text-gray-400 mt-1">Pencatat Keuangan Kelas</p>
            </header>

            <div class="my-4 p-4 bg-gray-900/70 rounded-lg shadow">
                 <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="month-select" class="block text-sm font-medium text-gray-300 mb-1">Bulan</label>
                        <select id="month-select" class="w-full px-3 py-2 border bg-gray-700 border-gray-600 text-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500"></select>
                    </div>
                    <div>
                        <label for="week-select" class="block text-sm font-medium text-gray-300 mb-1">Minggu</label>
                        <select id="week-select" class="w-full px-3 py-2 border bg-gray-700 border-gray-600 text-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="1">Minggu 1</option>
                            <option value="2">Minggu 2</option>
                            <option value="3">Minggu 3</option>
                            <option value="4">Minggu 4</option>
                        </select>
                    </div>
                </div>
                <div id="summary" class="text-center border-t border-gray-700 pt-4">
                    <p class="text-lg">Kas Terkumpul (Minggu Ini):</p>
                    <p id="total-kas" class="text-4xl font-bold text-green-400">Rp 0</p>
                    <p id="paid-summary" class="text-gray-400 mt-1">0 dari 36 siswa telah membayar.</p>
                </div>
                <div class="mt-4">
                    <p class="text-center font-semibold mb-2">Pilih Hari Pembayaran:</p>
                    <div class="grid grid-cols-2 gap-2">
                        <button id="btn-selasa" class="btn-day w-full py-2 px-4 rounded-lg border border-gray-600 bg-gray-700 hover:bg-gray-600">Selasa</button>
                        <button id="btn-jumat" class="btn-day w-full py-2 px-4 rounded-lg border border-gray-600 bg-gray-700 hover:bg-gray-600">Jumat</button>
                    </div>
                </div>
            </div>

            <main>
                <div id="student-list" class="space-y-2">
                    <!-- Student entries will be generated by JavaScript -->
                </div>
            </main>

            <footer class="mt-6 text-center">
                 <div class="flex justify-center gap-4">
                    <button id="download-button" class="bg-green-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-green-700 transition-colors">
                        Download Laporan
                    </button>
                    <button id="reset-button" class="bg-red-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-red-700 transition-colors">
                        Reset Minggu Ini
                    </button>
                 </div>
                <p class="text-xs text-gray-500 mt-4">User ID: <span id="user-id-display"></span></p>
            </footer>
        </div>
    </div>
    
    <div id="reset-modal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center p-4 hidden">
        <div class="bg-gray-800 border border-gray-700 rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-bold text-center">Konfirmasi Reset</h3>
            <p class="text-center text-gray-300 my-4">Yakin ingin mereset data pembayaran untuk minggu ini? Tindakan ini tidak dapat dibatalkan.</p>
            <div class="flex justify-end gap-3 mt-6">
                <button id="cancel-reset" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-500">Batal</button>
                <button id="confirm-reset" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Ya, Reset</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, onSnapshot, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Blok ini menangani konfigurasi Firebase.
        // Di lingkungan pratinjau, ini akan berjalan otomatis.
        // Jika di-deploy di tempat lain (seperti Vercel), ini akan menampilkan pesan error yang jelas.
        let firebaseConfig;
        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
        } else {
            document.body.innerHTML = `
                <div class="min-h-screen bg-gray-900 flex items-center justify-center p-4">
                    <div class="bg-red-800 border border-red-600 text-white px-4 py-3 rounded-lg relative max-w-lg" role="alert">
                        <strong class="font-bold text-lg block">Error Konfigurasi!</strong>
                        <span class="block mt-2">Konfigurasi Firebase tidak ditemukan. Untuk menjalankan website ini di Vercel atau hosting lain, Anda harus:</span>
                        <ol class="list-decimal list-inside mt-2 space-y-1">
                            <li>Membuat proyek sendiri di <a href="https://firebase.google.com/" target="_blank" class="underline">Firebase</a>.</li>
                            <li>Menyalin objek 'firebaseConfig' dari proyek Anda.</li>
                            <li>Mengganti blok 'firebaseConfig' di dalam kode dengan objek yang Anda salin.</li>
                        </ol>
                    </div>
                </div>`;
            throw new Error("Firebase config not found. Please follow the setup guide to deploy this application.");
        }
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'class-cash-xl';
        
        const STUDENT_LIST = [
            "Achmad Ilham", "Alvia Eren Istiqomah", "Ananda Ridho Aditama", "Amelia Dewi Maharani",
            "Angelita Aura Aprilia", "Anisa Nurul Aini", "Arifa Intan Nurlatif", "Aurellia Tungga Dewi",
            "Azzahra Putri Amira", "Cindy Intan Hadi Saputri", "Dhea Agusfina Al Warois",
            "Dhimas Satrio Kurniawan", "Farih Naura Asfiya", "Gaza Tanziilal Furqon",
            "Gista Nazuilla Armeli", "Intan Putri Agustina", "Irsya Nur Nazha", "Janice Vania",
            "Kanaya Anyhania Ramadhani", "Keyza Putri Ramadhani", "Laura Imalia Putri",
            "Lucky Leyva Lee Young Chu Jun", "Mochamad Akbar Saifudin Zuhri", "Muhamad Farhan Al Kafi",
            "Muhammad Nikko Setya Pratama", "Mutiara Nur Laili", "Nabilla Nois Raya Putri Setiawan",
            "Nandita Aulia", "Natasya Dewi", "Nia Avrillia", "Nicky Leyva Lee Young Chu Jun",
            "Nur Amira Triana Ikhsanty", "Risza Aulia Ainul Fitri", "Robana Qusnul Joelia",
            "Saecar Labib Kanhaya Siswanto", "Syevi Citrahrotunisa"
        ];
        const KAS_AMOUNT = 2000;

        const appView = document.getElementById('app-view');
        const studentListContainer = document.getElementById('student-list');
        const totalKasEl = document.getElementById('total-kas');
        const paidSummaryEl = document.getElementById('paid-summary');
        const btnSelasa = document.getElementById('btn-selasa');
        const btnJumat = document.getElementById('btn-jumat');
        const resetButton = document.getElementById('reset-button');
        const downloadButton = document.getElementById('download-button');
        const resetModal = document.getElementById('reset-modal');
        const cancelResetButton = document.getElementById('cancel-reset');
        const confirmResetButton = document.getElementById('confirm-reset');
        const userIdDisplay = document.getElementById('user-id-display');
        const monthSelect = document.getElementById('month-select');
        const weekSelect = document.getElementById('week-select');

        let db, auth, userId, collectionRef;
        let studentData = {};
        let currentDay = 'selasa';
        let currentMonth, currentYear, currentWeek;
        let isAuthReady = false;
        let unsubscribe;

        function populateMonthSelector() {
            const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            const startYear = 2025;
            const endYear = 2026;

            monthSelect.innerHTML = '';
            
            for (let i = 6; i < 12; i++) {
                const option = document.createElement('option');
                option.value = `${startYear}-${i + 1}`;
                option.textContent = `${months[i]} ${startYear}`;
                monthSelect.appendChild(option);
            }

            for (let i = 0; i <= 6; i++) {
                 const option = document.createElement('option');
                option.value = `${endYear}-${i + 1}`;
                option.textContent = `${months[i]} ${endYear}`;
                monthSelect.appendChild(option);
            }
        }

        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                        isAuthReady = true;
                        initializeAppLogic();
                    } else {
                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Sign-in error:", error);
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase init failed:", error);
            }
        }

        function initializeAppLogic() {
            if (!isAuthReady || !db) return;
            
            populateMonthSelector();

            monthSelect.value = '2025-7';
            weekSelect.value = '3';

            setupControls();
            updateDataForSelectedPeriod();
        }
        
        function updateDataForSelectedPeriod() {
            if (unsubscribe) unsubscribe();
            
            const [year, month] = monthSelect.value.split('-');
            currentYear = year;
            currentMonth = month;
            currentWeek = weekSelect.value;
            
            studentData = {};
            const collectionPath = `/artifacts/${appId}/public/data/${currentYear}-${currentMonth}/week-${currentWeek}/students`;
            collectionRef = collection(db, collectionPath);
            
            checkAndSeedData().then(listenForUpdates);
        }

        async function checkAndSeedData() {
            const docRef = doc(collectionRef, 'student_0');
            const docSnap = await getDoc(docRef);

            if (!docSnap.exists()) {
                console.log(`No data for ${currentYear}-${currentMonth} Week ${currentWeek}. Seeding...`);
                const batch = writeBatch(db);
                STUDENT_LIST.forEach((name, index) => {
                    const studentId = `student_${index}`;
                    const newStudentRef = doc(collectionRef, studentId);
                    batch.set(newStudentRef, { id: studentId, name: name, selasa: false, jumat: false });
                });
                await batch.commit();
            }
        }
        
        function listenForUpdates() {
            updateActiveDayButton();
            unsubscribe = onSnapshot(collectionRef, (snapshot) => {
                snapshot.docs.forEach(doc => {
                    studentData[doc.id] = doc.data();
                });
                renderStudentList();
                updateSummary();
            }, error => console.error("Error listening to collection:", error));
        }

        function renderStudentList() {
            studentListContainer.innerHTML = '';
            STUDENT_LIST.forEach((name, index) => {
                const studentId = `student_${index}`;
                const data = studentData[studentId] || { selasa: false, jumat: false };
                const hasPaid = data[currentDay];

                const entry = document.createElement('div');
                entry.className = `student-entry flex items-center justify-between p-3 rounded-lg shadow-sm ${hasPaid ? 'bg-green-500/10 text-green-300' : 'bg-red-500/10 text-red-300'}`;
                entry.dataset.id = studentId;

                const studentName = document.createElement('span');
                studentName.className = 'font-medium';
                studentName.textContent = `${index + 1}. ${name}`;

                const status = document.createElement('span');
                status.className = `font-bold text-sm px-2 py-1 rounded-full ${hasPaid ? 'bg-green-500/20' : 'bg-red-500/20'}`;
                status.textContent = hasPaid ? 'LUNAS' : 'BELUM';
                
                entry.appendChild(studentName);
                entry.appendChild(status);
                entry.addEventListener('click', () => togglePayment(studentId));
                studentListContainer.appendChild(entry);
            });
        }

        function updateSummary() {
            let paidCount = Object.values(studentData).filter(s => s[currentDay]).length;
            const total = paidCount * KAS_AMOUNT;
            totalKasEl.textContent = `Rp ${total.toLocaleString('id-ID')}`;
            paidSummaryEl.textContent = `${paidCount} dari ${STUDENT_LIST.length} siswa telah membayar.`;
        }

        function updateActiveDayButton() {
            btnSelasa.classList.toggle('active', currentDay === 'selasa');
            btnJumat.classList.toggle('active', currentDay === 'jumat');
        }

        function setupControls() {
            monthSelect.addEventListener('change', updateDataForSelectedPeriod);
            weekSelect.addEventListener('change', updateDataForSelectedPeriod);

            btnSelasa.addEventListener('click', () => {
                currentDay = 'selasa';
                updateActiveDayButton();
                renderStudentList();
                updateSummary();
            });
            btnJumat.addEventListener('click', () => {
                currentDay = 'jumat';
                updateActiveDayButton();
                renderStudentList();
                updateSummary();
            });

            resetButton.addEventListener('click', () => resetModal.classList.remove('hidden'));
            downloadButton.addEventListener('click', downloadReport);
            cancelResetButton.addEventListener('click', () => resetModal.classList.add('hidden'));
            confirmResetButton.addEventListener('click', async () => {
                await resetCurrentWeekPayments();
                resetModal.classList.add('hidden');
            });
        }

        async function togglePayment(studentId) {
            if (!studentData[studentId]) return;
            const currentStatus = studentData[studentId][currentDay];
            const studentDocRef = doc(collectionRef, studentId);
            try {
                const batch = writeBatch(db);
                batch.update(studentDocRef, { [currentDay]: !currentStatus });
                await batch.commit();
            } catch (error) {
                console.error("Error updating payment status:", error);
            }
        }

        async function resetCurrentWeekPayments() {
            const batch = writeBatch(db);
            Object.keys(studentData).forEach(studentId => {
                const studentDocRef = doc(collectionRef, studentId);
                batch.update(studentDocRef, { selasa: false, jumat: false });
            });
            try {
                await batch.commit();
            } catch (error) {
                console.error("Error during weekly reset:", error);
            }
        }

        function downloadReport() {
            const selectedMonthText = monthSelect.options[monthSelect.selectedIndex].text;
            const selectedWeekText = weekSelect.options[weekSelect.selectedIndex].text;

            let reportContent = `Laporan Kas Kelas X-L\n`;
            reportContent += `========================================\n`;
            reportContent += `Periode: ${selectedMonthText} - ${selectedWeekText}\n\n`;

            let totalSelasa = 0;
            let totalJumat = 0;

            Object.values(studentData).forEach(student => {
                if (student.selasa) totalSelasa += KAS_AMOUNT;
                if (student.jumat) totalJumat += KAS_AMOUNT;
            });
            
            const grandTotal = totalSelasa + totalJumat;
            reportContent += `Total Kas Terkumpul (Minggu Ini): Rp ${grandTotal.toLocaleString('id-ID')}\n`;
            reportContent += ` - Selasa: Rp ${totalSelasa.toLocaleString('id-ID')}\n`;
            reportContent += ` - Jumat: Rp ${totalJumat.toLocaleString('id-ID')}\n\n`;

            reportContent += `--- RINCIAN HARI SELASA ---\n`;
            STUDENT_LIST.forEach((name, index) => {
                const studentId = `student_${index}`;
                const status = studentData[studentId]?.selasa ? 'LUNAS' : 'BELUM';
                reportContent += `${(index + 1).toString().padStart(2, ' ')}. ${name.padEnd(35, ' ')}: ${status}\n`;
            });

            reportContent += `\n--- RINCIAN HARI JUMAT ---\n`;
            STUDENT_LIST.forEach((name, index) => {
                const studentId = `student_${index}`;
                const status = studentData[studentId]?.jumat ? 'LUNAS' : 'BELUM';
                reportContent += `${(index + 1).toString().padStart(2, ' ')}. ${name.padEnd(35, ' ')}: ${status}\n`;
            });
            
            reportContent += `\n\nLaporan dibuat pada: ${new Date().toLocaleString('id-ID')}\n`;

            const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `laporan-kas-X-L-${selectedMonthText.replace(/ /g, '-')}-${selectedWeekText.replace(/ /g, '-')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Initialize the app when the script loads
        initializeFirebase();
    </script>
</body>
</html>
